name: Sync Plants at 2

on:
  schedule:
    - cron: "30 20 * * *"   # Runs daily at 2:00 AM IST (20:30 UTC)
  workflow_dispatch:

jobs:
  call_api:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Call sync API (URL Hidden)
        id: sync
        run: |
          echo "Calling Sync API..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -o response.txt "${{ secrets.SYNC_API_URL }}")
          BODY=$(cat response.txt)
          STATUS=$(echo "$RESPONSE" | tail -n1)

          echo "HTTP Status: $STATUS"
          echo "Response Body: $BODY"

          # Export value for next step
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          # Fail job if API returns non-200 status
          if [ "$STATUS" -ne 200 ]; then
            echo "API FAILED!"
            exit 1
          fi

      - name: Send WhatsApp Alerts to Multiple Contacts (Free)
        if: failure()
        run: |
          echo '${{ secrets.WHATSAPP_CONTACTS }}' > contacts.json
          LENGTH=$(jq length contacts.json)

          echo "Sending WhatsApp alerts to $LENGTH recipients..."

          for (( i=0; i<${LENGTH}; i++ ))
          do
            PHONE=$(jq -r ".[$i].phone" contacts.json)
            KEY=$(jq -r ".[$i].key" contacts.json)

            echo "Sending alert to $PHONE ..."

            curl -G \
              --data-urlencode "phone=$PHONE" \
              --data-urlencode "apikey=$KEY" \
              --data-urlencode "text=⚠️ ALERT: Plant Sync FAILED! Check GitHub Actions immediately." \
              https://api.callmebot.com/whatsapp.php

            echo "Alert sent to $PHONE"
            echo ""
          done

